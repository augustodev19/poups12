{%extends 'core/base.html'%}

{%load static%}

{%block 'conteudo'%}

<div class="container  d-flex justify-content-start" style="gap:3rem; margin-top:10rem; overflow-x:auto; white-space: nowrap;">

{% for categoria in categorias %}

    <a class="d-flex flex-column align-items-center" href="{% url 'loja' %}?categoria={{ categoria.id }}&distancia={{ request.GET.distancia|default:'10' }}&freteGratis={{ request.GET.freteGratis|default:'nao' }}">
    <img style="width:5rem; height:5rem; object-fit:cover; border-radius:4px;" src="{{ categoria.foto.url }}" alt="{{ categoria.nome }}">
        <span>{{ categoria.nome }}</span>
    </a>
    {% endfor %}



</div>


<div class="container mt-5 d-flex justify-content-start" style="gap:1rem; overflow-x:auto; white-space: nowrap;">


<a>
    <img style="width: 20rem; height:12rem; object-fit:cover; border-radius:12px;" src="{%static 'img\linguica.webp' %}">

</a>
<a>
    <img style="width: 20rem; height:12rem; object-fit:cover; border-radius:12px;" src="{%static 'img\comida2.webp' %}">

</a>
<a>
    <img style="width: 20rem; height:12rem; object-fit:cover; border-radius:12px;" src="{%static 'img\comida3.webp' %}">

</a>


</div>

<div class="container mt-5 d-none">
    <h4>Mais PoupeComprando pra você</h4>

    <div class="mt-5 d-flex flex-column" style="width: fit-content;"> 

    <img style="width: 7rem;" src="{%static 'img\03cupons_ESAv.avif' %}">
    <span class="text-center">Cupons</span>
</div>

</div>


<div class="container mt-5 d-none  w-100" style="gap:2rem">
    <h4>Famosos no PoupeComprando</h4>

    <div class=" d-flex justify-content-start w-100" style="gap:2rem">
        <div class="mt-5 d-flex flex-column" style="width: fit-content;" > 

    <img style="width: 7rem;" src="{%static 'img\03cupons_ESAv.avif' %}">

    <span class="text-center">Cupons</span>
</div>

<div class="mt-5 d-flex flex-column" style="width: fit-content;" > 

    <img style="width: 7rem;" src="{%static 'img\03cupons_ESAv.avif' %}">

    <span class="text-center">Cupons</span>
</div>

</div>
</div>



<div class="container mt-5 d-none">
    <h4>Mais PoupeComprando pra você</h4>

    <div class="mt-5 d-flex flex-column" style="width: fit-content;"> 

    <img style="width: 7rem;" src="{% static  'img\03cupons_ESAv.avif' %}">
    <span class="text-center">Cupons</span>
</div>

</div>
<div class="d-none container mt-5">
   <img src="">
</div>


<div class="d-none container mt-5">

   <img src="">

</div>

<div class="container mt-5">
    <h3 class="mb-2"> Lojas </h3>

    <!-- HTML para o Slider -->


    <div id="distanciaModal" class="modal1">
        <div class="modal-content1">
          <div class="modal-header1">
            <h2 class="text-center">Onde você quer receber seu pedido?</h2>
          </div>
          <div class="modal-body1">
            <label for="distanciaSlider">Distância: <span id="distanciaValor">10</span> km</label>
            <input type="range" id="distanciaSlider" name="distancia" min="5" max="100" value="10">
            <button style="background:#b11000;" id="enviarDistancia">Enviar</button>
          </div>
        </div>
      </div>
    

      <div class="d-flex" style="overflow-x:auto; gap:1rem"> 

<a  id="filtroFreteGratis" class="btn-filter">Filtrar por Frete Grátis</a>
<a  class="btn-filter" id="abrirDistancia" >Distância</a>

<a class="btn-filter"  href="{%url 'loja' %}" id="filtroFreteGratis">Limpar filtros</a>

      </div>
<script>
    let abrirDistancia = document.querySelector('#abrirDistancia')
    let distanciaModal = document.querySelector('#distanciaModal')
    abrirDistancia.addEventListener('click', function()
    {
        distanciaModal.style.display = 'flex'
    })
    document.getElementById('filtroFreteGratis').addEventListener('click', function() {
        var url = new URL(window.location.href);
        var params = new URLSearchParams(url.search);
    
        // Mantém o valor atual da distância
        var distancia = params.get('distancia') || '10';
    
        // Adiciona o filtro de frete grátis à URL
        params.set('freteGratis', 'sim');
        params.set('distancia', distancia);
    
        // Mantém o valor atual da categoria
        var categoria = params.get('categoria');
        if (categoria) {
            params.set('categoria', categoria);
        }
    
        window.location.href = url.pathname + '?' + params.toString();
    });
</script>

<script>
    // Função para obter o valor do parâmetro 'distancia' da URL
    function getDistanciaFromURL() {
        var params = new URLSearchParams(window.location.search);
        return params.get('distancia'); // retorna null se o parâmetro não existir
        
    }

    // Função para verificar se o filtro de frete grátis está ativo
    function isFreteGratisActive() {
        var params = new URLSearchParams(window.location.search);
        return params.get('freteGratis') === 'sim'; // retorna true se freteGratis=sim
    }

    // Configurando o valor inicial do slider com base na URL
    window.onload = function() {
        var distancia = getDistanciaFromURL();
        if (distancia !== null) {
            document.getElementById('distanciaSlider').value = distancia;
            document.getElementById('distanciaValor').innerText = distancia;
        }
    };

    // Event listeners para o slider
    document.getElementById('distanciaSlider').addEventListener('input', function() {
        document.getElementById('distanciaValor').innerText = this.value;
    });

  // Event listener para atualização do valor do slider
document.getElementById('distanciaSlider').addEventListener('input', function() {
    document.getElementById('distanciaValor').innerText = this.value;
});

// Event listener para o botão 'Enviar Distância'
document.getElementById('enviarDistancia').addEventListener('click', function() {
    var distancia = document.getElementById('distanciaSlider').value;
    var url = new URL(window.location.href);
    var params = new URLSearchParams(url.search);

    // Verifica se o frete grátis está ativo
    var freteGratis = isFreteGratisActive() ? 'sim' : 'nao';

    // Mantém o valor atual da categoria
    var categoria = params.get('categoria');

    // Atualiza distância e frete grátis
    params.set('distancia', distancia);
    params.set('freteGratis', freteGratis);

    // Se a categoria estiver presente, adiciona ao URL
    if (categoria) {
        params.set('categoria', categoria);
    }

    window.location.href = url.pathname + '?' + params.toString();
});
</script>   


    <div class="mt-5 container-1">

{%for loja in lojas%}
<a  class="card-1" href="{% if user.is_authenticated %}{% url 'perfil_loja' loja.id %}{% else %}{% url 'registerCliente' %}?next=loja_{{loja.id}}{% endif %}">

<div >
<h2>{{loja.nomeLoja}}</h2>
<img style="width:5rem; height:5rem; border-radius:50%; object-fit:cover;" src="{{loja.foto.url}}">

<p class="mt-3">
    Ver Perfil
</p>

<p>Endereço: {{loja.endereco.rua}}, {{loja.endereco.bairro}}
</p>
<p>Distância: {{ loja.distancia_calculada|floatformat:2 }} km</p>
</div>
</a>

{%endfor%}
    </div>
</div>
{%endblock%}